<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YAIR</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.1/css/bulma.min.css">
  </head>
  <body>
  <section class="section">
    <div class="container">
        <div class="has-text-centered">
            You have Authorized
        </div>
        <div id="username"></div>
  </section>
  </body>

<script>
var info = ""

document.addEventListener('DOMContentLoaded', function() {
  const queryString = window.location.search;
  const urlParams = new URLSearchParams(queryString);
  const code = urlParams.get('code')

  const xhr = new XMLHttpRequest();
  xhr.open("POST", "https://www.reddit.com/api/v1/access_token", true);
  xhr.responseType = 'json';
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.setRequestHeader("Authorization", "Basic " + btoa("UBmFQRdzisR5CANmMfzAjw:MAJ7oNMMaNVAComGy2AIQfMRaLlDgQ"));
  xhr.onreadystatechange = () => {
    if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
      sessionStorage.setItem("access-token", xhr.response.access_token);
      sessionStorage.setItem("refresh-token", xhr.response.refresh_token)
      const user_info = api_get("api/v1/me", xhr.response.access_token)
      info = user_info.response
      document.querySelector("username").innerHTML = user_info.response.name
    }
  };
  xhr.send(`grant_type=authorization_code&code=${code}&redirect_uri=https://adhesivecheese.github.io/yair-web/callback.html`);

}, false);

function api_get(endpoint, token) {
  const xhr = new XMLHttpRequest();
  xhr.open("GET", "https://oauth.reddit.com/" + endpoint, true);
  xhr.responseType = 'json';
  xhr.setRequestHeader("Authorization", "bearer " + token);
  xhr.send();
  return xhr
}

</script>

</html>
